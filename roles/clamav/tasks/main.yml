---

- name: Install
  ansible.builtin.dnf:
    name:
      - clamav
      - clamav-update
      - clamd
    state: present
  become: true
  when: ansible_env.RUNNING_INSIDE_DOCKER is undefined
  tags:
    - clamav


- name: Refresh clamav database
  ansible.builtin.command: freshclam
  become: true
  ignore_errors: true
  when: ansible_env.RUNNING_INSIDE_DOCKER is undefined
  tags:
    - clamav

- name: Enable service to refresh clamav database at boot
  ansible.builtin.systemd:
    name: "{{ item }}"
    enabled: true
  become: True
  when: ansible_env.RUNNING_INSIDE_DOCKER is undefined
  loop:
    - clamav-freshclam.service
  tags:
    - clamav


- name: Setup clamav daemon config
  ansible.builtin.copy:
    content: |
      User clamscan

      VirusEvent /etc/clamav/virus-event.bash

      LogFile /var/log/clamd.scan
      LogSyslog yes
      MaxThreads 8

      ExcludePath ^/proc/
      ExcludePath ^/sys/
      ExcludePath ^/run/

      ###
      ### On Access Scanning
      ###
      OnAccessExcludeUname clamscan
      OnAccessExcludeRootUID true
      # Scan even when files are created or moved
      OnAccessExtraScanning true
      OnAccessMountPath /
      OnAccessIncludePath /home
      OnAccessExcludePath /proc/
      OnAccessExcludePath /sys/
      OnAccessExcludePath /run/

    dest: /etc/clam.d/scan.conf
    mode: 0644
  become: True
  when: ansible_env.RUNNING_INSIDE_DOCKER is undefined
  tags:
    - clamav


- name: Setup Virus Event Script
  ansible.builtin.copy:
    content: |
      PATH=/usr/bin
      ALERT="Signature detected by clamav: $CLAM_VIRUSEVENT_VIRUSNAME in $CLAM_VIRUSEVENT_FILENAME"

      for ADDRESS in /run/user/*; do
        USERID=${ADDRESS#/run/user/}
        /usr/bin/sudo -u "#$USERID" DBUS_SESSION_BUS_ADDRESS="unix:path=$ADDRESS/bus" PATH="$PATH" \
            /usr/bin/notify-send -u critical -i dialog-warning "Virus found!" "$ALERT"
      done
    dest: /etc/clamav/virus-event.bash
    mode: 0755
  become: True
  when: ansible_env.RUNNING_INSIDE_DOCKER is undefined
  tags:
    - clamav


- name: Override clamav-clamonacc.service (On Access Scanning) to use --fdpass
  ansible.builtin.copy:
    content: |
      [Service]
      ExecStart=
      ExecStart=/usr/sbin/clamonacc -F --config-file=/etc/clam.d/scan.conf --fdpass --log=/var/log/clamav/clamonacc.log
    dest: /etc/systemd/system/clamav-clamonacc.service.d/override.conf
    mode: 0644
  become: True
  when: ansible_env.RUNNING_INSIDE_DOCKER is undefined
  tags:
    - clamav
