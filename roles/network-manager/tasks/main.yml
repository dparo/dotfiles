---
- name: Install
  ansible.builtin.dnf:
    name:
      - systemd-resolved
      - NetworkManager
      - NetworkManager-tui
      - openvpn
      - openfortivpn
      - openconnect
    state: present
  become: true
  tags:
    - apt
    - network-manager
    - vpn


- name: Enable service
  ansible.builtin.systemd:
    name: NetworkManager
    enabled: true
  become: true
  when: ansible_env.RUNNING_INSIDE_DOCKER is undefined
  tags:
    - network-manager

- name: Ensure NetworkManager config dirs exists
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: "0755"
  loop:
    - "/etc/NetworkManager/conf.d/"
    - "/etc/NetworkManager/dispatcher.d/"
  become: true
  tags:
    - network-manager

- name: Setup mutually exclusive wifi / ethernet script dns servers
  ansible.builtin.copy:
    dest: /etc/NetworkManager/dispatcher.d/70-wifi-wired-exclusive.sh
    content: |
      #!/bin/bash
      export LC_ALL=C

      toggle_wifi ()
      {
        result=$(nmcli dev | grep "ethernet" | grep -w "connected")
        if [ -n "$result" ]; then
           nmcli radio wifi off
        else
           nmcli radio wifi on
        fi
      }

      if [ "$2" = "up" ]; then
        toggle_wifi
      fi

      if [ "$2" = "down" ]; then
        toggle_wifi
      fi
    mode: "u=rwx,g=rwx,o=rx"
  become: true
  tags:
    - network-manager


- name: Clone openvpn-systemd-resolved
  ansible.builtin.git:
    clone: yes
    depth: 1
    dest: "/etc/openvpn-systemd-resolved"
    force: yes
    repo: https://github.com/jonathanio/update-systemd-resolved
    single_branch: yes
    update: yes
    version: master
  register: clone
  tags:
    - openvpn
    - openvpn-systemd-resolved

- name: Symlink config
  ansible.builtin.file:
    src: "{{ item }}"
    dest: "{{ ansible_user_dir }}/.config/{{ item | basename }}"
    state: link
  loop:
    - "{{ role_path }}/files/config/networkmanager-dmenu"
  tags:
    - network-manager
