---
- name: Install (Package Manager)
  ansible.builtin.dnf:
    name:
      - kitty
    state: present
  become: true
  tags:
    - kitty

- name: Check latest kitty
  ansible.builtin.uri:
    url: https://api.github.com/repos/kovidgoyal/kitty/releases/latest
    return_content: true
  register: kitty
  tags:
    - kitty

- name: Create install dir
  ansible.builtin.file:
    path: "{{ ansible_user_dir }}/opt/kitty"
    state: directory
    mode: "0755"
  tags:
    - kitty

- name: Download and unpack kitty {{ kitty['json']['tag_name'] }}

  ansible.builtin.unarchive:
    src: "{{ gh_repo }}/releases/download/{{ kitty['json']['tag_name'] }}/kitty-{{ kitty['json']['tag_name'][1:] }}-x86_64.txz"
    dest: "{{ ansible_user_dir }}/opt/kitty"
    remote_src: true
  tags:
    - kitty

- name: Desktop integration
  ansible.builtin.shell: |
    cp -f ~/opt/kitty/share/applications/kitty.desktop ~/.local/share/applications/
    cp -f ~/opt/kitty/share/applications/kitty-open.desktop ~/.local/share/applications/
    sed -i "s|Icon=kitty|Icon=/home/$USER/opt/kitty/share/icons/hicolor/256x256/apps/kitty.png|g" ~/.local/share/applications/kitty*.desktop
    sed -i "s|Exec=kitty|Exec=/home/$USER/opt/kitty/bin/kitty|g" ~/.local/share/applications/kitty*.desktop
  tags:
    - kitty

- name: Symlink binary
  ansible.builtin.file:
    src: "{{ ansible_user_dir }}/opt/kitty/bin/{{ item }}"
    dest: "{{ ansible_user_dir }}/.local/bin/{{ item }}"
    state: link
  loop:
    - kitty
    - kitten
  tags:
    - kitty

- name: Symlink config
  ansible.builtin.file:
    src: "{{ role_path }}/files"
    dest: "{{ ansible_user_dir }}/.config/kitty"
    state: link
  tags:
    - kitty

- name: Setup x-terminal-emulator
  ansible.builtin.file:
    src: "{{ ansible_user_dir }}/.local/bin/kitty"
    dest: "{{ ansible_user_dir }}/.local/bin/x-terminal-emulator"
    state: link
  tags:
    - kitty

# Setup xdg-terminal-exec (Overrides default terminal used by `glib/gio/gdesktopappinfo.c` which affects programs such as `gtk-launch` and `nautilus`)
# See: https://gitlab.gnome.org/GNOME/glib/-/blob/main/gio/gdesktopappinfo.c, known_terminals[] array. Glib uses a predefined set of terminals with precedence.
# See: https://gitlab.freedesktop.org/xdg/xdg-specs/-/issues/54
- name: Setup xdg-terminal-exec
  ansible.builtin.file:
    src: "{{ ansible_user_dir }}/.local/bin/kitty"
    dest: "{{ ansible_user_dir }}/.local/bin/xdg-terminal-exec"
    state: link
  tags:
    - kitty

- name: Setup GNOME preferred terminal to kitty
  ansible.builtin.shell: |
    gsettings set org.gnome.desktop.default-applications.terminal exec kitty
    gsettings set org.gnome.desktop.default-applications.terminal exec-arg '--'
    gsettings set org.cinnamon.desktop.default-applications.terminal exec kitty
    gsettings set org.cinnamon.desktop.default-applications.terminal exec-arg '--'
    true
  ignore_errors: true
  tags:
    - kitty
