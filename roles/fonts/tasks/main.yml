---
- name: Install minimal fonts (DNF)
  ansible.builtin.dnf:
    name:
      - ibm-plex-mono-fonts
      - ibm-plex-sans-fonts
      - ibm-plex-serif-fonts
    state: present
  become: true
  tags:
    - fonts

- name: Symlink fontconfig
  ansible.builtin.file:
    src: "{{ item }}"
    dest: "{{ ansible_user_dir }}/.config/{{ item | basename }}"
    state: link
  loop:
    - "{{ role_path }}/files/fontconfig"
  tags:
    - fonts
    - fontconfig


- name: Create NerdFonts subdir
  ansible.builtin.file:
    path: "/usr/local/share/fonts/NerdFonts"
    state: directory
    mode: "0755"
  become: true
  tags:
    - fonts

- name: Check if Nerd fonts are already installed
  ansible.builtin.stat:
    path: "/usr/local/share/fonts/NerdFonts/{{ item }}"
  loop: '{{ nerd_fonts }}'
  register: fonts_dir


- name: Create necessary NerdFonts subdir
  ansible.builtin.file:
    path: "/usr/local/share/fonts/NerdFonts/{{ item }}"
    state: directory
    mode: "0755"
  loop: "{{ nerd_fonts }}"
  become: true
  tags:
    - fonts


- name: Download Nerd Fonts
  ansible.builtin.unarchive:
    src: "https://github.com/ryanoasis/nerd-fonts/releases/latest/download/{{ item.item }}.zip"
    dest: "/usr/local/share/fonts/NerdFonts/{{ item.item }}"
    remote_src: yes
  become: true
  when: 'item.stat.exists == False'
  loop: "{{ fonts_dir.results }}"
  tags:
    - fonts

- name: Find Windows compatible Nerd fonts
  ansible.builtin.find:
    paths: /usr/local/share/fonts/NerdFonts
    patterns: "^.*Windows Compatible.*.ttf$"
    use_regex: yes
    recurse: True
  register: windows_compatible_fonts
  tags:
    - fonts


- name: Remove Windows compatible Nerd fonts
  ansible.builtin.file:
    path: "{{ item.path }}"
    state: absent
  become: true
  loop: "{{ windows_compatible_fonts.files | flatten(levels=1) }}"
  tags:
    - fonts

- name: Reload font cache
  ansible.builtin.command: fc-cache -fvr
  when: "fonts_dir.results | length > 0"
  ignore_errors: True
  tags:
    - fonts

- name: Refresh X11 font cache
  ansible.builtin.command: xset fp rehash
  ignore_errors: True
  when: "fonts_dir.results | length > 0"
  tags:
    - fonts
